<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>揭秘iOS中的差分隐私系统 | ro2en - tech blog</title>
<meta name="keywords" content="差分隐私, 隐私技术">
<meta name="description" content="笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程">
<meta name="author" content="ro2en">
<link rel="canonical" href="http://localhost:1313/zh/posts/iosdpsystem/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.1fc7633352002c726fac2f2267f2f70aa2fd3784e85196c36b507bda4d3ee0ad.css" integrity="sha256-H8djM1IALHJvrC8iZ/L3CqL9N4ToUZbDa1B72k0&#43;4K0=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/iosdpsystem/">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/zh/posts/iosdpsystem/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css">
<meta property="og:title" content="揭秘iOS中的差分隐私系统" />
<meta property="og:description" content="笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/zh/posts/iosdpsystem/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-29T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="揭秘iOS中的差分隐私系统"/>
<meta name="twitter:description" content="笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "揭秘iOS中的差分隐私系统",
      "item": "http://localhost:1313/zh/posts/iosdpsystem/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "揭秘iOS中的差分隐私系统",
  "name": "揭秘iOS中的差分隐私系统",
  "description": "笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程",
  "keywords": [
    "差分隐私", "隐私技术"
  ],
  "articleBody": "笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程度；本文还将展示部分调查技术，使未来的研究者更容易对系统的新变化进行追踪。\n差分隐私（Differential Privacy）是隐私技术的一种，它能够使数据公司在不侵犯用户隐私的情况下对其数据进行统计分析或模型训练，从而提高服务质量。为了规避合规风险，越来越多的数据公司开始将这项技术应用在其数字服务中。\n这项技术的核心是使用差分隐私算法对用户数据进行随机化处理。\n在 2016 年苹果全球开发者大会 (WWDC) 上，苹果公司提出将使用「差分隐私技术」对其 iOS 和 macOS 系统中的用户使用数据进行统计分析。\n苹果的官方文档声称，当用户开启设置-隐私权与安全性-分析与改进功能-分享iPhone与Apple Watch分析时，本地设备会对用户使用某些服务产生的数据进行隐私化处理（注入随机噪声），再定期将处理后的数据报告给其服务器进行大规模分析，以改进特定服务。\n隐私化处理是指对不同类型的数据使用不同的差分隐私算法。这些算法由一系列随机过程组成，受到参数 $\\epsilon$ 限制。参数 $\\epsilon$ 量化了用户隐私的损失： $\\epsilon$ 的数值越小，用户的隐私越能得到保护，但是统计分析的准确度会降低。\n2017 年，研究人员对 macOS Sierra (10.12) 中的差分隐私系统进行了逆向工程1，发现该系统所有服务每天一共会有16次隐私损失，并且会随着时间的推移不断累积，这远远超过了学界可接受的范围。2017 年底，苹果公开了 DP 系统的部分细节，包括用户设备上的粗略数据收集过程、算法细节等，并介绍了几个具体使用案例及其相应参数。\n迄今为止，苹果生态系统已历经多次迭代。目前还没有一项全面的调查能揭示 iOS 中 DP 系统的实施情况。苹果公司在其文档中概述了七项服务，除此之外，在《2020 年曝光通知隐私保护分析（ENPA）》白皮书[1]中，苹果公司声称也将使用 DP 技术处理用户曝光信息，但目前有多少服务使用了 DP 技术仍未披露。此外，这些服务收集的具体用户使用数据仍不为人所知，用户应该有知情权；但苹果公司的隐私权政策并未明确提及用户数据实例。归根结底，在 DP 系统中保护用户隐私的关键在于差分隐私算法的具体实施，这一点还有待评估。\n截至2023年2月，由unc0ver发布的可稳定越狱的最新iOS版本为14.6。因此笔者详尽调查了iOS 14.6（硬件为iPhone 8）中差分隐私系统的技术实施细节。本文将提及与用户隐私密切相关的数据收集过程和被收集的具体用户数据，使用户能够了解自己所受到的隐私保护程度；本文还将展示部分调查技术，使未来的研究者更容易对系统的新变化进行追踪。\n开始调查 笔者采用一种开黑盒的方式来追踪差分隐私系统的组件：在系统目录的所有文件中匹配字符串DifferentialPrivacy\n# 匹配字符串的方法 sudo grep -ri 'DifferentialPrivacy' / file_path sudo ack 'DifferentialPrivacy' / file_path 对结果进行分析后，我们发现了一些可能与差分隐私系统相关的文件：\n# daemon及其配置文件(.plist) Binary file /usr/libexec/dprivacyd Binary file /System/Library/LaunchDaemons/com.apple.dprivacyd.plist # 系统函数库/框架 /System/Library/PrivateFrameworks/DifferentialPrivacy.framework/Versions/A/DifferentialPrivacy.tbd /System/Library/PrivateFrameworks/DifferentialPrivacy.framework/XPCServices/DPSubmissionService.xpc/Contents/MacOS/DPSubmissionService /System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/dyld_shared_cache_* # 配置文件 Binary file /System/Library/DifferentialPrivacy/Configuration/com.apple.dprivacyd.* /var/mobile/Library/DifferentialPrivacy/Configuration/ /private/var/mobile/Library/DifferentialPrivacy//Configuration/ # 数据库 /private/var/mobile/Library/DifferentialPrivacy/DifferentialPrivacyClassC.db-wal # 其他文件 /var/mobile/Library/DifferentialPrivacy//Configuration/Blacklists /System/Library/DifferentialPrivacy/Configuration/Blacklists/ /var/mobile/Library/Logs/CrashReporter/Retired/ 关于守护进程（Daemon） 在苹果生态系统中，守护进程（Daemon）是一种在后台运行并提供服务的系统级进程。每个Daemon都由一个可执行程序和一个描述其行为的.plist文件组成。操作系统在启动时，首先启动名为launchd的根进程，launchd会检查/System/Library/LaunchDaemons下所有的.plist文件，再启动对应的Daemon。\n# 示例 macOS Sonoma 14.4.1 ~ cd /System/Library/LaunchDaemons ; ls bootps.plist com.apple.AirPlayXPCHelper.plist com.apple.AppSSOAgent.login.plist com.apple.AppSSODaemon.plist com.apple.AppleCredentialManagerDaemon.plist ... com.apple.dprivacyd.plist ... 根据上一步的结果，守护进程dprivacyd很可能与处理差分隐私任务相关。考察其配置文件com.apple.dprivacyd.plist是探索dprivacyd行为的第一步。\n分析dprivacyd配置文件 可使用Xcode或下面的指令来浏览.plist文件：\nplistutil -i com.apple.dprivacyd.plist [iOS14.6中的com.apple.dprivacyd.plist文件，用Xcode打开]\n配置文件中有以下两个值得注意的条目：\nProgram的值为Daemon可执行文件的位置/usr/libexec/dprivacyd LaunchEvents中的com.apple.xpc.activity字段展示了9个XPC活动。加载Daemon配置时，后台会注册其中的XPC活动，再依照配置由系统安排执行。Repeating=YES表示这些XPC活动周期运行，Interval定义了运行的周期，单位是秒（如86400表示24小时） 从这9个XPC活动的名称中，我们可大致推断出它们承担着「系统维护、报告生成和报告提交」的任务。为了进一步探索这些活动的行为，我们随后会在Console.app中进行追踪。\n运行dprivacyd 为了后续对dprivacyd进程进行动态分析，需要保证它能持续稳定地运行。我们的思路是首先判断dprivacyd是否正在运行；若没有，我们能够手动运行dprivacyd进程。\n有多种方法可以判断当前用户是否启动了dprivacyd守护进程，其中使用frida-ps需安装frida并在macOS中进行设置（参考这篇）\n# 1. 使用 ps ps -ef | grep 'dprivacyd' # 2. 使用 frida-ps frida-ps -U | grep 'dprivacyd' # 3. 使用 launchctl 查看当前用户域加载的进程, 501为用户uid launchctl print gui/501 # 如果dprivacyd已加载，还可以查看其详细信息（包括已启动/未启动） launchctl print gui/501/com.apple.dprivacyd 即使当前dprivacyd正在运行，我们也需要寻找能手动运行它的方法，以便在它没有运行时启动它。不幸的是，笔者在初次测试时，dprivacyd并未启动。\n经过一番测试，我发现：在设置中开启/关闭数据分享，dprivacyd进程不会立即启动/停止（后续测试中发现，这一设置会立即终止dprivacyd收集数据的行为，但不会终止进程。变动设置只影响程序流，也是一种安全策略）；使用launchctl kickstart在用户域中重启dprivacyd能够立即启动该进程，而使用launchctl bootout卸载用户域中的dprivacyd可以立即终止该进程。\n# 重启Daemon sudo launchctl kickstart -k gui/501/com.apple.dprivacyd sudo launchctl kickstart -k system/com.apple.dprivacyd # 卸载Daemon配置，可以终止进程 launchctl bootout gui/501 /System/Library/LaunchDaemons/com.apple.dprivacyd.plist 关于系统库 在初步调查中，我们发现了位于/System/Library/PrivateFrameworks中的一个系统私有库DifferentialPrivacy.framework。通过名称，我们猜测这很有能是dprivacyd在运行过程中主要依赖的函数库，也是苹果差分隐私系统核心的函数库。\n通过检查DifferentialPrivacy.framework的文件结构，我们发现\nDifferentialPrivacyDataModel.momd 文件夹存储了许多版本的数据模型。在VersionInfo.plist中我们发现每个数据模型文件中含有一些数据记录的类名，这可能与使用的隐私算法相关，而当前使用的数据模型是 v11 版本。修改后缀.mom为.plist可以使用Xcode浏览数据模型文件。数据模型文件中定义了许多类名（如CMSRecord）及用 Objective-C 语言声明的参数（如creationDate/lastUpdate/balance）。这应该是DifferentialPrivacy.framework使用的类。 XPCServices文件夹包含集成到框架中的 XPC 服务，这种服务打包了一些特定功能，开箱即用。在iOS14.6中只有DPSubmissionService.xpc一项服务，其中DPSubmissionService为二进制可执行文件（可反汇编来静态分析），Info.plist为配置文件。 framework.sb是该库的二进制文件，但不可执行。实际的二进制文件已合并到位于/System/Library/Caches/com.apple.dyld/的 dyld 共享缓存中。缓存因 CPU 架构而异。在我们的例子中，dyld 共享缓存名为 dyld_shared_cache_arm64*。分析该库的二进制文件，需要加载整个dyld缓存文件并定位到名为DifferentialPrivacy.Framework的库。 此时我们已经获得了苹果差分隐私系统主要依赖的函数库，之后可以采用ida Pro/Ghidra/Hopper Disassmbler对具体函数行为进行静态分析。\n关于配置文件 在初步调查中，我们还发现了三组配置文件，位于以下三个路径中。\n/System/Library/DifferentialPrivacy/Configuration/ /var/mobile/Library/DifferentialPrivacy/Configuration/ /private/var/mobile/Library/DifferentialPrivacy/Configuration/ 在进一步调查中我们发现，第一组配置文件的修改日期在iOS14.6系统发布前后，意味着它们是iOS14.6的默认配置文件，在系统发布后保持不变。而后两组配置文件内容一致，要么全空，要么有一些修改时间较近的配置文件，猜测为不断更新的用户级别的配置文件。\n在iOS14.6系统配置文件夹中内的所有文件大致有三种：\n目录下的配置文件，名称为com.apple.dprivacyd.{keynames, keyproperties, budgetproperties, algorithmparameters}.plist，共有4组。 Blacklists文件夹中的配置文件，名称为com.apple.*.blacklist BitValueMaps文件夹中的配置文件，名称为com.apple.health.datatypes.usage.monthly.plist 站在这篇研究的肩上，我们分析了这组庞大的配置文件。发现它们揭露了所有使用差分隐私技术的服务、这些服务收集的数据类型、每一种类型的隐私预算、使用的差分隐私算法以及算法参数等等。未来的研究者可以通过该配置文件快速掌握使用差分隐私算法的服务和每一种服务的隐私损失情况。\n分析配置文件 我们将4个配置文件聚合为一个清晰的表单。我们初步猜测，KeyNames的值为苹果差分隐私系统收集的数据类型，如com.apple.proactive.messages.en。PropertiesName则可能是使用差分隐私系统的服务，如com.apple.proactive.messages.{en/es/fr/ja/zh-Hans} 共享相同的 PropertiesName：ProactiveMessages。\n每个BudgetKeyName包含了多项PropertiesName，也就是说很可能多种服务采用同一种隐私预算类型。而每个预算类型由一组BudgetProperties定义其行为，根据关键词Refill/Second/Interval/Amount..我们猜测这些预算类型由不同填充间隔和数值区分。这里的预算可能是指向苹果服务器提交数据记录的频率。\n在keyproperties.plist中，每一种PropertiesName都映射有一个PrivitizationAlgorithm和一个ServerAlgorithmString，它们指代这一服务采用的差分隐私算法，并且在设备本地和服务器端采用的算法可能有所不同。而PrivacyParameter和AlgorithmParameters则确定了本地差分隐私算法的参数，其中PrivacyParameter就是量化用户隐私损失的隐私参数 $\\epsilon$。而transport可能指代这一数据记录向服务器提交的方式。\n我们将在后续分析中逐一确定这些参数的含义。\n黑名单文件中含有大量扩展名为.blacklist的文件。我们可以使用txt对其直接浏览。我们观察到，系统配置文件夹中的黑名单文件第一个字符串为1，而用户配置文件夹中则为2。除此之外，每一行都有一个字符串关键词，可能表示不需要收集/被屏蔽的数据内容。\nBitValueMaps文件夹中的配置文件只有一个配置文件com.apple.health.datatypes.usage.monthly.plist。这是一个长度为84的数组，表示Health应用程序中的84种不同数据类型。这个文件夹可能专门存放有多重维度的数据类型的配置文件，并且每种维度只统计是/否两组可能。\n关于数据库 我们在第一步调查中，还发现了一个数据库路径 /private/var/mobile/Library/DifferentialPrivacy/DifferentialPrivacyClassC.db*。在这个路径下一共有三个数据库文件：\nDifferentialPrivacyClassC.db DifferentialPrivacyClassC.db-wal DifferentialPrivacyClassC.db-shm 后两者是临时数据库文件。可以使用sqlite3以root权限打开数据库；或者使用ssh将其复制到mac的任意文件目录下，修改数据库权限，再使用DB Browser for SQLite打开.db文件，随后所有三个数据库文件将自动合并为一个文件。\n可以看到，这个数据库共有 13 个表。在Z_PRIMARYKEY表中，我们发现15个与DifferentialPrivacyDataModel-v11.mom相同的类名，由Z_ENT标注了它们的索引。而前10个表都有Z_ENT这一索引，并且表名又和类名高度相似，这表明每个表可能包含多个模型类。由于当前数据库中的记录有限，我们首先选择通过静态方法分析其对应关系。\n仔细研究DifferentialPrivacyDataModel-v11.mom后，我们发现在类名后紧跟属于此类的参数名，而这些参数名刚好可以和表内的索引名匹配。举个例子，下图左侧数据模型中的CMSRecord, CMSSequence, HCMSWord, HCMSSequence这四个类名后面的参数，刚好在右侧ZCMSRECORD表中有对应的索引名。\n这意味着前8个数据库的列表中的记录，可以通过数据库 (SQL) 操作，与DifferentialPrivacy.Framework中的类对象互相转化，被加载到dprivacyd进程中。\n按照这样的方法，我们确定了前10个数据库表对应了哪些框架中的类。我们还发现，除了ZPRIVACYBUDGETRECORD和ZMODELINFORECORD，其他8个表的命名方式又与配置文件PrivitizationAlgorithm / ServerAlgorithm / DataAlgorithm给出的差分隐私算法名高度相似。我们将初步推测的「数据库表名（Table Name）、框架类名（Class Name）、配置文件中的算法名（Algorithm Name）」三者的关系总结如下：\n由算法名称命名的8个表，存放的是与相关算法有关的经过隐私化处理的数据记录。这些表共享多个索引Z_PK, Z_ENT, Z_OPT, ZREPORTVERSION, ZSUBMITTED, ZCREATIONDATE, ZKEY，而其他独有的索引则与隐私算法相关。如果此前一直没有开启数据分析，这些表可能空空如也。\n但ZPRIVACYBUDGETRECORD表满满当当。32个条目中ZKEY中的值与配置文件com.apple.dprivacyd.budgetproperties中的32个BudgetKeyName一一对应，而ZBALANCE字段中的值与配置文件中的SessionAmount数值也完全相同。我们还可以看到ZCREATIONDATE和ZLASTUPDATE的数值为NSDate类型的时间戳，为相对1970年的秒数，是指该预算记录的创建时间戳和最后更新时间戳。ZREPORTVERSION指报告版本，该字段在iOS 14.6的记录中的数值均为21。Z_OPT和ZSUBMITTED尚且不知，但我在存有隐私化记录的表中观察到，只有少数记录的ZSUBMITTED数值为1，其他都为0。并且当ZSUBMITTED=0时，Z_OPT=1；当ZSUBMITTED=1时，Z_OPT=2。这可能表明ZSUBMITTED指该记录是否被提交到报告中，而Z_OPT指该记录是否被选择提交。这一点会在下一步分析中验证。\n另外三个表ZMODELINFORECORD, Z_MODELCACHE, Z_METADATA要么没有任何记录，要么其记录只和数据模型信息有关。不必做更多调查。\n系统如何运行 在初步调查了苹果差分隐私系统的组件（进程、框架、配置文件和数据库）后，下一步是对差分隐私系统的核心进程dprivacyd进行逆向分析，从而理解它如何承载系统的各种任务。\n逆向分析 dprivacyd的二进制文件位于/usr/libexec/dprivacyd，它是一个mach-o格式的可执行文件，可以使用各种工具浏览或者解析它的静态文件（如 otool, machOView, Hopper Disassembler等），也可以使用工具对运行中的它进行动态分析（如Frida）。 我们首先采用静态分析的方式对它进行探索，尤其是获得后续进行动态分析时需要的方法名；随后我们采用动态分析为主，静态为辅的方法探索dprivacyd的行为。\n我们用Hopper Disassembler对dprivacyd二进制文件反汇编分析，在Load Command中LC_LOAD_DYLIB写出了这个进程用到的4个动态库，除了系统核心库之外，只有DifferentialPrivacy.Framework。\nLC_LOAD_DYLIB (DifferentialPrivacy) LC_LOAD_DYLIB (Foundation) LC_LOAD_DYLIB (libobjc.A.dylib) LC_LOAD_DYLIB (libSystem.B.dylib) 我们还找到唯一的函数也是入口函数，它创建了一个_DPServer类对象，并可能调用了类中一个方法。而_DPServer类属于DifferentialPrivacy.Framework框架。\n确定了类名我们就可以用Frida对dprivacyd进行动态分析了。确保dprivacyd运行后，我们使用frida-trace追踪_DP开头的 Objective-C 方法，同时在Console应用中监视dprivacyd的输出。我们先分析系统自身的行为，因此不与测试机进行交互。\nfrida-trace -U dprivacyd -m \"*[_DP* *]\" ……短时间内没有任何输出。我使用 Amphetamine 应用使macOS保持唤醒状态，持续监控了至少24小时，终于获得了 Daemon 所调用方法，在Console中也有一长串与运行XPC活动有关的日志，我将日志简化如下（以serverBlacklistUpdate这个XPC活动为例）。可以发现，XPC活动由dasd(com.apple.duetactivityscheduler) 周期性地根据运行条件进行评估，若评估分数高于阈值则决定执行。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 # dasd Running activities: {( com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA )} Activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA has delayed start # UserEventAgent REQUESTING START: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA Initiating XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104b4ae00) # dprivacyd _xpc_activity_dispatch: beginning dispatch, activity name com.apple.DifferentialPrivacy.serverBlacklistUpdate, seqno 1 _xpc_activity_dispatch: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0): found an activity with matching seqno 1 _xpc_activity_dispatch: lower half, activity name com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), seqno from top half was 1 _xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 2 _xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 2 # UserEventAgent Running XPC Activity (PID 990): com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104b4ae00) STARTING: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA # dprivacyd _xpc_activity_set_state_from_cts: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), set activity state to 2 __XPC_ACTIVITY_CALLING_HANDLER__: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), current state 2, pending state 0 # dasd STARTING activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA \u003c_DASActivity: \"com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA\", Maintenance, 60s, [24.03.23, 04:06:09 - 25.03.23, 04:06:09], Started at 21.03.23, 16:08:14, Endpoint: (null), Upload=0, UploadSize=0, DownloadSize=5000, WiFi-Only=0, Group: com.apple.dasd.defaultNetwork, PID: 990, (Started at 21.03.23, 16:08:14)\u003e! With com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA ...Tasks running in group [com.apple.dasd.defaultNetwork] are 1! Not tracking activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA # dprivacyd _xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 4 __XPC_ACTIVITY_CALLING_HANDLER__ returned from handler: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), current state 2, pending state 4 _xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 4 ... # dprivacyd _xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 5 _xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104432cf0), 5 # UserEventAgent Completed XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104b4ae00) # dasd COMPLETED com.apple.DifferentialPrivacy.serverBlacklistUpdate:090B72 at priority 5 ! NO LONGER RUNNING com.apple.DifferentialPrivacy.serverBlacklistUpdate:090B72 ...Tasks running in group [com.apple.dasd.defaultNetwork] are 0! Submitted Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:2A40D9 at priority 5 with interval 86400 # UserEventAgent Rescheduling XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate (0x104b4ae00) SUBMITTING: com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527 # dasd Submitted Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527 at priority 5 with interval 86400 \u003c_DASActivity: \"com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527\", Maintenance, 60s, [24.03.23, 04:08:25 - 25.03.23, 04:08:25], Group: \"com.apple.dasd.defaultNetwork\", Networking: Upload=0, UploadSize=0, DownloadSize=5000, WiFi-Only=0, Require Device Inactivity, Plugin Required, Dark-Wake Eligible, Interval=1440, Budgeted, Delayed Start, User Specified: { }\u003e Activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527 start beyond the 21 hour interval 为了能不等待这么久，我们需要一种能快速启动这些XPC活动的手段，来追踪它们调用的方法。\n随时启动XPC活动 过去的一段时间，我的项目需要对一个越狱的iOS设备的系统级进程（Daemon）进行动态分析，它的.plist中定义了许多XPC活动。\n但由于这些XPC活动是周期运行，最短间隔12小时，最长则是24小时，有时它们还需要在系统条件满足时执行。我不想等这么久来获得我想要追踪的结果。\n我非常幸运地找到了这篇文章（Running XPC Activities On Demand）\n哪些情况会触发数据收集？收集了什么？ 当用户使用某些特定应用程序时，他们的操作会产生大量数据。这些数据会从用户通过特定服务（如键盘守护进程 kbd ）或直接从服务（如 suggestd 守护进程）流向应用程序。当数据流到达某些服务时，服务会记录并通过进程间通信（Cross-Process Communication - XPC）机制发送给 dprivacyd。dprivacyd 收到服务的明文数据后，会决定是否记录这些数据。如果用户在 设置→隐私→分析和改进→分享iPhone分析 中选择了 “记录”，dprivacyd 就会决定记录，然后通过算法将数据私有化并存储到数据库中。\n使用「差分隐私技术」的服务 Privacy Loss in Apple’s Implementation of Differential Privacy on MacOS 10.12 ↩︎\n",
  "wordCount" : "8010",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2023-10-29T00:00:00Z",
  "dateModified": "2023-10-29T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "ro2en"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/zh/posts/iosdpsystem/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ro2en - tech blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/zh/" class="logo-text" accesskey="h" title="ro2en - tech blog (Alt + H)">ro2en - tech blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24">
                        <path id="adjust-solid" d="M8,17a9,9,0,1,0,9-9A9,9,0,0,0,8,17Zm9,6.677V10.323a6.677,6.677,0,1,1,0,13.355Z" transform="translate(12.728 -11.314) rotate(45)" fill="currentColor"/>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24">
                        <path id="adjust-solid" d="M8,17a9,9,0,1,0,9-9A9,9,0,0,0,8,17Zm9,6.677V10.323a6.677,6.677,0,1,1,0,13.355Z" transform="translate(12.728 -11.314) rotate(45)" fill="currentColor"/>
                    </svg>   
                    
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="en"
                            aria-label="en">en</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/zh/archives/" title="歸檔">
                    <span>歸檔</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/frtags" title="標籤">
                    <span>標籤</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/frseries" title="系列">
                    <span>系列</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/frcategories" title="類目">
                    <span>類目</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/zh/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      揭秘iOS中的差分隐私系统
    </h1>
    <div class="post-meta"><span title='2023-10-29 00:00:00 +0000 UTC'>十月 29, 2023</span>&nbsp;·&nbsp;16 分钟&nbsp;·&nbsp;ro2en&nbsp;|&nbsp;语言:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/posts/iosdpsystem/">en</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%bc%80%e5%a7%8b%e8%b0%83%e6%9f%a5" aria-label="开始调查">开始调查</a><ul>
                        
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8bdaemon" aria-label="关于守护进程（Daemon）">关于守护进程（Daemon）</a><ul>
                        
                <li>
                    <a href="#%e5%88%86%e6%9e%90dprivacyd%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="分析dprivacyd配置文件">分析dprivacyd配置文件</a></li>
                <li>
                    <a href="#%e8%bf%90%e8%a1%8cdprivacyd" aria-label="运行dprivacyd">运行dprivacyd</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e7%b3%bb%e7%bb%9f%e5%ba%93" aria-label="关于系统库">关于系统库</a></li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="关于配置文件">关于配置文件</a><ul>
                        
                <li>
                    <a href="#%e5%88%86%e6%9e%90%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="分析配置文件">分析配置文件</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e6%95%b0%e6%8d%ae%e5%ba%93" aria-label="关于数据库">关于数据库</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9f%e5%a6%82%e4%bd%95%e8%bf%90%e8%a1%8c" aria-label="系统如何运行">系统如何运行</a><ul>
                        
                <li>
                    <a href="#%e9%80%86%e5%90%91%e5%88%86%e6%9e%90" aria-label="逆向分析">逆向分析</a><ul>
                        
                <li>
                    <a href="#%e9%9a%8f%e6%97%b6%e5%90%af%e5%8a%a8xpc%e6%b4%bb%e5%8a%a8" aria-label="随时启动XPC活动">随时启动XPC活动</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%93%aa%e4%ba%9b%e6%83%85%e5%86%b5%e4%bc%9a%e8%a7%a6%e5%8f%91%e6%95%b0%e6%8d%ae%e6%94%b6%e9%9b%86%e6%94%b6%e9%9b%86%e4%ba%86%e4%bb%80%e4%b9%88" aria-label="哪些情况会触发数据收集？收集了什么？">哪些情况会触发数据收集？收集了什么？</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%b7%ae%e5%88%86%e9%9a%90%e7%a7%81%e6%8a%80%e6%9c%af%e7%9a%84%e6%9c%8d%e5%8a%a1" aria-label="使用「差分隐私技术」的服务">使用「差分隐私技术」的服务</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>笔者对iOS14.6的差分隐私系统进行了逆向工程，旨在揭露其具体收集的用户数据和对用户数据的处理过程，希望用户能够了解自己所受到的隐私保护程度；本文还将展示部分调查技术，使未来的研究者更容易对系统的新变化进行追踪。</p>
<hr>
<p>差分隐私（Differential Privacy）是隐私技术的一种，它能够使数据公司在不侵犯用户隐私的情况下对其数据进行统计分析或模型训练，从而提高服务质量。为了规避合规风险，越来越多的数据公司开始将这项技术应用在其数字服务中。</p>
<p>这项技术的核心是使用<strong>差分隐私算法</strong>对用户数据进行随机化处理。</p>
<p>在 <a href="https://developer.apple.com/videos/wwdc2016">2016 年苹果全球开发者大会 (WWDC) </a>上，苹果公司提出将使用「差分隐私技术」对其 iOS 和 macOS 系统中的用户使用数据进行统计分析。</p>
<p>苹果的<a href="https://www.apple.com/privacy/docs/Differential_Privacy_Overview.pdf">官方文档</a>声称，当用户开启<code>设置-隐私权与安全性-分析与改进功能-分享iPhone与Apple Watch分析</code>时，本地设备会对用户使用某些服务产生的数据进行隐私化处理（注入随机噪声），再定期将处理后的数据报告给其服务器进行大规模分析，以改进特定服务。</p>
<p>隐私化处理是指对不同类型的数据使用不同的<strong>差分隐私算法</strong>。这些算法由一系列随机过程组成，受到参数 $\epsilon$ 限制。参数 $\epsilon$ 量化了用户隐私的损失： $\epsilon$ 的数值越小，用户的隐私越能得到保护，但是统计分析的准确度会降低。</p>
<p>2017 年，研究人员对 macOS Sierra (10.12) 中的差分隐私系统进行了逆向工程<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>，发现该系统所有服务每天一共会有16次隐私损失，并且会随着时间的推移不断累积，这远远超过了学界可接受的范围。2017 年底，苹果公开了 <a href="https://docs-assets.developer.apple.com/ml-research/papers/learning-with-privacy-at-scale.pdf">DP 系统的部分细节</a>，包括用户设备上的粗略数据收集过程、算法细节等，并介绍了几个具体使用案例及其相应参数。</p>
<p>迄今为止，苹果生态系统已历经多次迭代。目前还没有一项全面的调查能揭示 iOS 中 DP 系统的实施情况。苹果公司在其文档中概述了七项服务，除此之外，在《2020 年曝光通知隐私保护分析（ENPA）》白皮书[1]中，苹果公司声称也将使用 DP 技术处理用户曝光信息，但目前有多少服务使用了 DP 技术仍未披露。此外，这些服务收集的具体用户使用数据仍不为人所知，用户应该有知情权；但苹果公司的隐私权政策并未明确提及用户数据实例。归根结底，在 DP 系统中保护用户隐私的关键在于差分隐私算法的具体实施，这一点还有待评估。</p>
<p>截至2023年2月，由<a href="https://unc0ver.dev/">unc0ver</a>发布的可稳定越狱的最新iOS版本为14.6。因此笔者详尽调查了iOS 14.6（硬件为iPhone 8）中差分隐私系统的技术实施细节。本文将提及与用户隐私密切相关的数据收集过程和被收集的具体用户数据，使用户能够了解自己所受到的隐私保护程度；本文还将展示部分调查技术，使未来的研究者更容易对系统的新变化进行追踪。</p>
<h2 id="开始调查">开始调查<a hidden class="anchor" aria-hidden="true" href="#开始调查">#</a></h2>
<p>笔者采用一种开黑盒的方式来追踪差分隐私系统的组件：在系统目录的所有文件中匹配字符串<code>DifferentialPrivacy</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 匹配字符串的方法</span>
</span></span><span class="line"><span class="cl">sudo grep -ri <span class="s1">&#39;DifferentialPrivacy&#39;</span> / file_path
</span></span><span class="line"><span class="cl">sudo ack <span class="s1">&#39;DifferentialPrivacy&#39;</span> / file_path
</span></span></code></pre></div><p>对结果进行分析后，我们发现了一些可能与差分隐私系统相关的文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># daemon及其配置文件(.plist)</span>
</span></span><span class="line"><span class="cl">Binary file /usr/libexec/dprivacyd
</span></span><span class="line"><span class="cl">Binary file /System/Library/LaunchDaemons/com.apple.dprivacyd.plist
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 系统函数库/框架</span>
</span></span><span class="line"><span class="cl">/System/Library/PrivateFrameworks/DifferentialPrivacy.framework/Versions/A/DifferentialPrivacy.tbd
</span></span><span class="line"><span class="cl">/System/Library/PrivateFrameworks/DifferentialPrivacy.framework/XPCServices/DPSubmissionService.xpc/Contents/MacOS/DPSubmissionService
</span></span><span class="line"><span class="cl">/System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/dyld_shared_cache_*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置文件</span>
</span></span><span class="line"><span class="cl">Binary file /System/Library/DifferentialPrivacy/Configuration/com.apple.dprivacyd.*
</span></span><span class="line"><span class="cl">/var/mobile/Library/DifferentialPrivacy/Configuration/
</span></span><span class="line"><span class="cl">/private/var/mobile/Library/DifferentialPrivacy//Configuration/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 数据库</span>
</span></span><span class="line"><span class="cl">/private/var/mobile/Library/DifferentialPrivacy/DifferentialPrivacyClassC.db-wal
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 其他文件</span>
</span></span><span class="line"><span class="cl">/var/mobile/Library/DifferentialPrivacy//Configuration/Blacklists
</span></span><span class="line"><span class="cl">/System/Library/DifferentialPrivacy/Configuration/Blacklists/
</span></span><span class="line"><span class="cl">/var/mobile/Library/Logs/CrashReporter/Retired/
</span></span></code></pre></div><h3 id="关于守护进程daemon">关于守护进程（Daemon）<a hidden class="anchor" aria-hidden="true" href="#关于守护进程daemon">#</a></h3>
<p>在苹果生态系统中，守护进程（Daemon）是一种在后台运行并提供服务的系统级进程。每个Daemon都由一个可执行程序和一个描述其行为的<code>.plist</code>文件组成。操作系统在启动时，首先启动名为<code>launchd</code>的根进程，<code>launchd</code>会检查<code>/System/Library/LaunchDaemons</code>下所有的<code>.plist</code>文件，再启动对应的Daemon。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 示例 macOS Sonoma 14.4.1</span>
</span></span><span class="line"><span class="cl">~ <span class="nb">cd</span> /System/Library/LaunchDaemons <span class="p">;</span> ls
</span></span><span class="line"><span class="cl">bootps.plist
</span></span><span class="line"><span class="cl">com.apple.AirPlayXPCHelper.plist
</span></span><span class="line"><span class="cl">com.apple.AppSSOAgent.login.plist
</span></span><span class="line"><span class="cl">com.apple.AppSSODaemon.plist
</span></span><span class="line"><span class="cl">com.apple.AppleCredentialManagerDaemon.plist
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">com.apple.dprivacyd.plist
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>根据上一步的结果，守护进程<code>dprivacyd</code>很可能与处理差分隐私任务相关。考察其配置文件<code>com.apple.dprivacyd.plist</code>是探索<code>dprivacyd</code>行为的第一步。</p>
<h4 id="分析dprivacyd配置文件">分析dprivacyd配置文件<a hidden class="anchor" aria-hidden="true" href="#分析dprivacyd配置文件">#</a></h4>
<p>可使用Xcode或下面的指令来浏览<code>.plist</code>文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">plistutil -i com.apple.dprivacyd.plist
</span></span></code></pre></div><p><img loading="lazy" src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714311610/blog/iosdpsystem/plist_uimpyg.png" alt="plist"  />
[iOS14.6中的<code>com.apple.dprivacyd.plist</code>文件，用Xcode打开]</p>
<p>配置文件中有以下两个值得注意的条目：</p>
<ul>
<li><code>Program</code>的值为Daemon可执行文件的位置<code>/usr/libexec/dprivacyd</code></li>
<li><code>LaunchEvents</code>中的<code>com.apple.xpc.activity</code>字段展示了9个<a href="https://developer.apple.com/documentation/xpc/xpc_activities?language=objc">XPC活动</a>。加载Daemon配置时，后台会注册其中的XPC活动，再依照配置由系统安排执行。<code>Repeating=YES</code>表示这些XPC活动周期运行，<code>Interval</code>定义了运行的周期，单位是秒（如86400表示24小时）</li>
</ul>
<p>从这9个XPC活动的名称中，我们可大致推断出它们承担着「系统维护、报告生成和报告提交」的任务。为了进一步探索这些活动的行为，我们随后会在Console.app中进行追踪。</p>
<h4 id="运行dprivacyd">运行dprivacyd<a hidden class="anchor" aria-hidden="true" href="#运行dprivacyd">#</a></h4>
<blockquote>
<p>为了后续对<code>dprivacyd</code>进程进行动态分析，需要保证它能持续稳定地运行。我们的思路是首先判断<code>dprivacyd</code>是否正在运行；若没有，我们能够手动运行<code>dprivacyd</code>进程。</p>
</blockquote>
<p>有多种方法可以判断当前用户是否启动了<code>dprivacyd</code>守护进程，其中使用<code>frida-ps</code>需安装frida并在macOS中进行设置（参考<a href="https://naehrdine.blogspot.com/2022/11/macos-frida-setup.html">这篇</a>）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 1. 使用 ps</span>
</span></span><span class="line"><span class="cl">ps -ef <span class="p">|</span> grep <span class="s1">&#39;dprivacyd&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 使用 frida-ps</span>
</span></span><span class="line"><span class="cl">frida-ps -U <span class="p">|</span> grep <span class="s1">&#39;dprivacyd&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3. 使用 launchctl 查看当前用户域加载的进程, 501为用户uid</span>
</span></span><span class="line"><span class="cl">launchctl print gui/501
</span></span><span class="line"><span class="cl"><span class="c1"># 如果dprivacyd已加载，还可以查看其详细信息（包括已启动/未启动）</span>
</span></span><span class="line"><span class="cl">launchctl print gui/501/com.apple.dprivacyd
</span></span></code></pre></div><p>即使当前<code>dprivacyd</code>正在运行，我们也需要寻找能手动运行它的方法，以便在它没有运行时启动它。不幸的是，笔者在初次测试时，<code>dprivacyd</code>并未启动。</p>
<p>经过一番测试，我发现：在设置中开启/关闭数据分享，<code>dprivacyd</code>进程不会立即启动/停止（后续测试中发现，这一设置会立即终止<code>dprivacyd</code>收集数据的行为，但不会终止进程。<strong>变动设置只影响程序流</strong>，也是一种安全策略）；使用<code>launchctl kickstart</code>在用户域中重启<code>dprivacyd</code>能够立即启动该进程，而使用<code>launchctl bootout</code>卸载用户域中的<code>dprivacyd</code>可以立即终止该进程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 重启Daemon</span>
</span></span><span class="line"><span class="cl">sudo launchctl kickstart -k gui/501/com.apple.dprivacyd
</span></span><span class="line"><span class="cl">sudo launchctl kickstart -k system/com.apple.dprivacyd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 卸载Daemon配置，可以终止进程</span>
</span></span><span class="line"><span class="cl">launchctl bootout gui/501 /System/Library/LaunchDaemons/com.apple.dprivacyd.plist
</span></span></code></pre></div><h3 id="关于系统库">关于系统库<a hidden class="anchor" aria-hidden="true" href="#关于系统库">#</a></h3>
<p>在初步调查中，我们发现了位于<code>/System/Library/PrivateFrameworks</code>中的一个系统私有库<code>DifferentialPrivacy.framework</code>。通过名称，我们猜测这很有能是<code>dprivacyd</code>在运行过程中主要依赖的函数库，也是苹果差分隐私系统核心的函数库。</p>
<img src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714389105/blog/iosdpsystem/framework_iieq3u.png" alt="AltText" style="width: 60%; "/>
<p>通过检查<code>DifferentialPrivacy.framework</code>的文件结构，我们发现</p>
<ul>
<li><code>DifferentialPrivacyDataModel.momd</code> 文件夹存储了许多版本的数据模型。在<code>VersionInfo.plist</code>中我们发现每个数据模型文件中含有一些数据记录的类名，这可能与使用的隐私算法相关，而当前使用的数据模型是 v11 版本。修改后缀<code>.mom</code>为<code>.plist</code>可以使用Xcode浏览数据模型文件。数据模型文件中定义了许多类名（如<code>CMSRecord</code>）及用 Objective-C 语言声明的参数（如<code>creationDate/lastUpdate/balance</code>）。这应该是<code>DifferentialPrivacy.framework</code>使用的类。</li>
<li><code>XPCServices</code>文件夹包含集成到框架中的 XPC 服务，这种服务打包了一些特定功能，开箱即用。在iOS14.6中只有<code>DPSubmissionService.xpc</code>一项服务，其中<code>DPSubmissionService</code>为二进制可执行文件（可反汇编来静态分析），<code>Info.plist</code>为配置文件。</li>
<li><code>framework.sb</code>是该库的二进制文件，但不可执行。实际的二进制文件已合并到位于<code>/System/Library/Caches/com.apple.dyld/</code>的 <strong>dyld 共享缓存</strong>中。缓存因 CPU 架构而异。在我们的例子中，dyld 共享缓存名为 <code>dyld_shared_cache_arm64*</code>。分析该库的二进制文件，需要加载整个dyld缓存文件并定位到名为<code>DifferentialPrivacy.Framework</code>的库。</li>
</ul>
<p>此时我们已经获得了苹果差分隐私系统主要依赖的函数库，之后可以采用ida Pro/Ghidra/Hopper Disassmbler对具体函数行为进行静态分析。</p>
<h3 id="关于配置文件">关于配置文件<a hidden class="anchor" aria-hidden="true" href="#关于配置文件">#</a></h3>
<p>在初步调查中，我们还发现了三组配置文件，位于以下三个路径中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/System/Library/DifferentialPrivacy/Configuration/
</span></span><span class="line"><span class="cl">/var/mobile/Library/DifferentialPrivacy/Configuration/
</span></span><span class="line"><span class="cl">/private/var/mobile/Library/DifferentialPrivacy/Configuration/
</span></span></code></pre></div><p>在进一步调查中我们发现，第一组配置文件的修改日期在iOS14.6系统发布前后，意味着它们是iOS14.6的默认配置文件，在系统发布后保持不变。而后两组配置文件内容一致，要么全空，要么有一些修改时间较近的配置文件，猜测为不断更新的用户级别的配置文件。</p>
<p>在iOS14.6系统配置文件夹中内的所有文件大致有三种：</p>
<ol>
<li>目录下的配置文件，名称为<code>com.apple.dprivacyd.{keynames, keyproperties, budgetproperties, algorithmparameters}.plist</code>，共有4组。</li>
<li><code>Blacklists</code>文件夹中的配置文件，名称为<code>com.apple.*.blacklist</code></li>
<li><code>BitValueMaps</code>文件夹中的配置文件，名称为<code>com.apple.health.datatypes.usage.monthly.plist</code></li>
</ol>
<p>站在<a href="https://arxiv.org/abs/1709.02753#:~:text=Privacy%20Loss%20in%20Apple's%20Implementation%20of%20Differential%20Privacy%20on%20MacOS%2010.12,-Jun%20Tang%2C%20Aleksandra&text=In%20June%202016%2C%20Apple%20announced,of%20Apple's%20approach%20remained%20sparse.">这篇研究</a>的肩上，我们分析了这组庞大的配置文件。发现它们揭露了所有<strong>使用差分隐私技术的服务、这些服务收集的数据类型、每一种类型的隐私预算、使用的差分隐私算法以及算法参数</strong>等等。未来的研究者可以<strong>通过该配置文件快速掌握使用差分隐私算法的服务和每一种服务的隐私损失情况</strong>。</p>
<h4 id="分析配置文件">分析配置文件<a hidden class="anchor" aria-hidden="true" href="#分析配置文件">#</a></h4>
<p>我们将4个配置文件聚合为一个清晰的表单。我们初步猜测，<code>KeyNames</code>的值为苹果差分隐私系统收集的数据类型，如<code>com.apple.proactive.messages.en</code>。<code>PropertiesName</code>则可能是使用差分隐私系统的服务，如<code>com.apple.proactive.messages.{en/es/fr/ja/zh-Hans}</code> 共享相同的 <code>PropertiesName</code>：<code>ProactiveMessages</code>。</p>
<p>每个<code>BudgetKeyName</code>包含了多项<code>PropertiesName</code>，也就是说很可能多种服务采用同一种隐私预算类型。而每个预算类型由一组<code>BudgetProperties</code>定义其行为，根据关键词<code>Refill/Second/Interval/Amount..</code>我们猜测这些预算类型由不同填充间隔和数值区分。这里的<strong>预算</strong>可能是指<strong>向苹果服务器提交数据记录的频率</strong>。</p>
<p>在<code>keyproperties.plist</code>中，每一种<code>PropertiesName</code>都映射有一个<code>PrivitizationAlgorithm</code>和一个<code>ServerAlgorithmString</code>，它们指代这一服务采用的<strong>差分隐私算法</strong>，并且在设备本地和服务器端采用的算法可能有所不同。而<code>PrivacyParameter</code>和<code>AlgorithmParameters</code>则确定了本地差分隐私算法的参数，<strong>其中<code>PrivacyParameter</code>就是量化用户隐私损失的隐私参数 $\epsilon$</strong>。而<code>transport</code>可能指代这一数据记录<strong>向服务器提交的方式</strong>。</p>
<p>我们将在后续分析中逐一确定这些参数的含义。</p>
<hr>
<p>黑名单文件中含有大量扩展名为<code>.blacklist</code>的文件。我们可以使用txt对其直接浏览。我们观察到，系统配置文件夹中的黑名单文件第一个字符串为1，而用户配置文件夹中则为2。除此之外，每一行都有一个字符串关键词，可能表示不需要收集/被屏蔽的数据内容。</p>
<p><code>BitValueMaps</code>文件夹中的配置文件只有一个配置文件<code>com.apple.health.datatypes.usage.monthly.plist</code>。这是一个长度为84的数组，表示Health应用程序中的84种不同数据类型。这个文件夹可能专门存放有多重维度的数据类型的配置文件，并且每种维度只统计是/否两组可能。</p>
<h3 id="关于数据库">关于数据库<a hidden class="anchor" aria-hidden="true" href="#关于数据库">#</a></h3>
<p>我们在第一步调查中，还发现了一个数据库路径 <code>/private/var/mobile/Library/DifferentialPrivacy/DifferentialPrivacyClassC.db*</code>。在这个路径下一共有三个数据库文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">DifferentialPrivacyClassC.db
</span></span><span class="line"><span class="cl">DifferentialPrivacyClassC.db-wal
</span></span><span class="line"><span class="cl">DifferentialPrivacyClassC.db-shm
</span></span></code></pre></div><p>后两者是临时数据库文件。可以使用<code>sqlite3</code>以root权限打开数据库；或者使用<code>ssh</code>将其复制到mac的任意文件目录下，修改数据库权限，再使用<a href="https://sqlitebrowser.org/">DB Browser for SQLite</a>打开<code>.db</code>文件，随后所有三个数据库文件将自动合并为一个文件。</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714398893/blog/iosdpsystem/db_ra5nak.png" alt="plist"  />
</p>
<p>可以看到，这个数据库共有 13 个表。在<code>Z_PRIMARYKEY</code>表中，我们发现15个与<code>DifferentialPrivacyDataModel-v11.mom</code>相同的类名，由<code>Z_ENT</code>标注了它们的索引。而前10个表都有<code>Z_ENT</code>这一索引，并且表名又和类名高度相似，这表明每个表可能包含多个模型类。由于当前数据库中的记录有限，我们首先选择通过静态方法分析其对应关系。</p>
<p>仔细研究<code>DifferentialPrivacyDataModel-v11.mom</code>后，我们发现在类名后紧跟属于此类的参数名，而这些参数名刚好可以和表内的索引名匹配。举个例子，下图左侧数据模型中的<code>CMSRecord, CMSSequence, HCMSWord, HCMSSequence</code>这四个类名后面的参数，刚好在右侧<code>ZCMSRECORD</code>表中有对应的索引名。</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714421246/blog/iosdpsystem/map_o8bca7.png" alt="map"  />
</p>
<p>这意味着前8个数据库的列表中的记录，可以通过数据库 (SQL) 操作，与<code>DifferentialPrivacy.Framework</code>中的类对象互相转化，被加载到<code>dprivacyd</code>进程中。</p>
<p>按照这样的方法，我们确定了前10个数据库表对应了哪些框架中的类。我们还发现，除了<code>ZPRIVACYBUDGETRECORD</code>和<code>ZMODELINFORECORD</code>，其他8个表的命名方式又与配置文件<code>PrivitizationAlgorithm / ServerAlgorithm / DataAlgorithm</code>给出的差分隐私算法名高度相似。我们将初步推测的「数据库表名（Table Name）、框架类名（Class Name）、配置文件中的算法名（Algorithm Name）」三者的关系总结如下：</p>
<img src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714419002/blog/iosdpsystem/tablename_gfp3l2.jpg" alt="AltText" style="width: 80%; "/>
<p>由算法名称命名的8个表，存放的是与相关算法有关的<strong>经过隐私化处理的数据记录</strong>。这些表共享多个索引<code>Z_PK, Z_ENT, Z_OPT, ZREPORTVERSION, ZSUBMITTED, ZCREATIONDATE, ZKEY</code>，而其他独有的索引则与隐私算法相关。如果此前一直没有开启数据分析，这些表可能空空如也。</p>
<p>但<code>ZPRIVACYBUDGETRECORD</code>表满满当当。32个条目中<code>ZKEY</code>中的值与配置文件<code>com.apple.dprivacyd.budgetproperties</code>中的32个<code>BudgetKeyName</code>一一对应，而<code>ZBALANCE</code>字段中的值与配置文件中的<code>SessionAmount</code>数值也完全相同。我们还可以看到<code>ZCREATIONDATE</code>和<code>ZLASTUPDATE</code>的数值为<code>NSDate</code>类型的时间戳，为相对1970年的秒数，是指该预算记录的创建时间戳和最后更新时间戳。<code>ZREPORTVERSION</code>指报告版本，该字段在iOS 14.6的记录中的数值均为21。<code>Z_OPT</code>和<code>ZSUBMITTED</code>尚且不知，但我在存有隐私化记录的表中观察到，只有少数记录的<code>ZSUBMITTED</code>数值为1，其他都为0。并且当<code>ZSUBMITTED=0</code>时，<code>Z_OPT=1</code>；当<code>ZSUBMITTED=1</code>时，<code>Z_OPT=2</code>。这可能表明<code>ZSUBMITTED</code>指该记录是否被提交到报告中，而<code>Z_OPT</code>指该记录是否被选择提交。这一点会在下一步分析中验证。</p>
<p>另外三个表<code>ZMODELINFORECORD, Z_MODELCACHE, Z_METADATA</code>要么没有任何记录，要么其记录只和数据模型信息有关。不必做更多调查。</p>
<h2 id="系统如何运行">系统如何运行<a hidden class="anchor" aria-hidden="true" href="#系统如何运行">#</a></h2>
<p>在初步调查了苹果差分隐私系统的组件（进程、框架、配置文件和数据库）后，下一步是对差分隐私系统的核心进程<code>dprivacyd</code>进行逆向分析，从而理解它如何承载系统的各种任务。</p>
<h3 id="逆向分析">逆向分析<a hidden class="anchor" aria-hidden="true" href="#逆向分析">#</a></h3>
<p><code>dprivacyd</code>的二进制文件位于<code>/usr/libexec/dprivacyd</code>，它是一个mach-o格式的可执行文件，可以使用各种工具浏览或者解析它的静态文件（如 otool, machOView, Hopper Disassembler等），也可以使用工具对运行中的它进行动态分析（如Frida）。
我们首先采用静态分析的方式对它进行探索，尤其是获得后续进行动态分析时需要的方法名；随后我们采用<strong>动态分析为主，静态为辅</strong>的方法探索<code>dprivacyd</code>的行为。</p>
<p>我们用Hopper Disassembler对<code>dprivacyd</code>二进制文件反汇编分析，在Load Command中<code>LC_LOAD_DYLIB</code>写出了这个进程用到的4个动态库，除了系统核心库之外，只有<code>DifferentialPrivacy.Framework</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">LC_LOAD_DYLIB (DifferentialPrivacy)
</span></span><span class="line"><span class="cl">LC_LOAD_DYLIB (Foundation)
</span></span><span class="line"><span class="cl">LC_LOAD_DYLIB (libobjc.A.dylib)
</span></span><span class="line"><span class="cl">LC_LOAD_DYLIB (libSystem.B.dylib)
</span></span></code></pre></div><p>我们还找到唯一的函数也是入口函数，它创建了一个<code>_DPServer</code>类对象，并可能调用了类中一个方法。而<code>_DPServer</code>类属于<code>DifferentialPrivacy.Framework</code>框架。</p>
<p><img loading="lazy" src="https://res.cloudinary.com/dyzugxjmt/image/upload/v1714475429/blog/iosdpsystem/Screenshot_2024-04-30_at_13.09.18_cpugrw.png" alt="daemon"  />
</p>
<p>确定了类名我们就可以用Frida对<code>dprivacyd</code>进行动态分析了。确保<code>dprivacyd</code>运行后，我们使用<code>frida-trace</code>追踪<code>_DP</code>开头的 Objective-C 方法，同时在Console应用中监视<code>dprivacyd</code>的输出。我们先分析系统自身的行为，因此不与测试机进行交互。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">frida-trace -U dprivacyd -m <span class="s2">&#34;*[_DP* *]&#34;</span>
</span></span></code></pre></div><p>……短时间内没有任何输出。我使用 Amphetamine 

<img class="in-text" height="18" src="https://is1-ssl.mzstatic.com/image/thumb/Purple116/v4/b9/93/46/b99346d8-5dcd-e78a-25fe-8810a64771ce/AppIcon-0-0-85-220-0-4-0-2x.png/434x0w.webp" alt="">
应用使macOS保持唤醒状态，持续监控了至少24小时，终于获得了 Daemon 所调用方法，在Console中也有一长串与运行XPC活动有关的日志，我将日志简化如下（以<code>serverBlacklistUpdate</code>这个XPC活动为例）。可以发现，XPC活动由<code>dasd</code>(<code>com.apple.duetactivityscheduler</code>) 周期性地根据运行条件进行评估，若评估分数高于阈值则决定执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># dasd</span>
</span></span><span class="line"><span class="cl">Running activities: <span class="o">{(</span> com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA <span class="o">)}</span>
</span></span><span class="line"><span class="cl">Activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA has delayed start
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UserEventAgent</span>
</span></span><span class="line"><span class="cl">REQUESTING START: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA
</span></span><span class="line"><span class="cl">Initiating XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104b4ae00<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dprivacyd</span>
</span></span><span class="line"><span class="cl">_xpc_activity_dispatch: beginning dispatch, activity name com.apple.DifferentialPrivacy.serverBlacklistUpdate, seqno <span class="m">1</span>
</span></span><span class="line"><span class="cl">_xpc_activity_dispatch: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>: found an activity with matching seqno <span class="m">1</span>
</span></span><span class="line"><span class="cl">_xpc_activity_dispatch: lower half, activity name com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, seqno from top half was <span class="m">1</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">2</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UserEventAgent</span>
</span></span><span class="line"><span class="cl">Running XPC Activity <span class="o">(</span>PID 990<span class="o">)</span>: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104b4ae00<span class="o">)</span>
</span></span><span class="line"><span class="cl">STARTING: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1"># dprivacyd</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state_from_cts: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="nb">set</span> activity state to <span class="m">2</span>
</span></span><span class="line"><span class="cl">__XPC_ACTIVITY_CALLING_HANDLER__: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, current state 2, pending state <span class="m">0</span>
</span></span><span class="line"><span class="cl">	    
</span></span><span class="line"><span class="cl"><span class="c1"># dasd</span>
</span></span><span class="line"><span class="cl">STARTING activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA &lt;_DASActivity: <span class="s2">&#34;com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA&#34;</span>, Maintenance, 60s, <span class="o">[</span>24.03.23, 04:06:09 - 25.03.23, 04:06:09<span class="o">]</span>, Started at 21.03.23, 16:08:14, Endpoint: <span class="o">(</span>null<span class="o">)</span>, <span class="nv">Upload</span><span class="o">=</span>0, <span class="nv">UploadSize</span><span class="o">=</span>0, <span class="nv">DownloadSize</span><span class="o">=</span>5000, WiFi-Only<span class="o">=</span>0, Group: com.apple.dasd.defaultNetwork, PID: 990, <span class="o">(</span>Started at 21.03.23, 16:08:14<span class="o">)</span>&gt;!
</span></span><span class="line"><span class="cl">With com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA ...Tasks running in group <span class="o">[</span>com.apple.dasd.defaultNetwork<span class="o">]</span> are 1!
</span></span><span class="line"><span class="cl">Not tracking activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:D8C1DA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dprivacyd</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">4</span>
</span></span><span class="line"><span class="cl">__XPC_ACTIVITY_CALLING_HANDLER__ returned from handler: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, current state 2, pending state <span class="m">4</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dprivacyd</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">5</span>
</span></span><span class="line"><span class="cl">_xpc_activity_set_state: send new state to CTS: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104432cf0<span class="o">)</span>, <span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UserEventAgent</span>
</span></span><span class="line"><span class="cl">Completed XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104b4ae00<span class="o">)</span>
</span></span><span class="line"><span class="cl">	    
</span></span><span class="line"><span class="cl"><span class="c1"># dasd</span>
</span></span><span class="line"><span class="cl">COMPLETED com.apple.DifferentialPrivacy.serverBlacklistUpdate:090B72 at priority <span class="m">5</span> &lt;private&gt;!
</span></span><span class="line"><span class="cl">NO LONGER RUNNING com.apple.DifferentialPrivacy.serverBlacklistUpdate:090B72 ...Tasks running in group <span class="o">[</span>com.apple.dasd.defaultNetwork<span class="o">]</span> are 0!
</span></span><span class="line"><span class="cl">Submitted Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:2A40D9 at priority <span class="m">5</span> with interval <span class="m">86400</span> &lt;private&gt;
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1"># UserEventAgent</span>
</span></span><span class="line"><span class="cl">Rescheduling XPC Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate <span class="o">(</span>0x104b4ae00<span class="o">)</span>
</span></span><span class="line"><span class="cl">SUBMITTING: com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527
</span></span><span class="line"><span class="cl">	    
</span></span><span class="line"><span class="cl"><span class="c1"># dasd</span>
</span></span><span class="line"><span class="cl">Submitted Activity: com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527 at priority <span class="m">5</span> with interval <span class="m">86400</span> &lt;_DASActivity: <span class="s2">&#34;com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527&#34;</span>, Maintenance, 60s, <span class="o">[</span>24.03.23, 04:08:25 - 25.03.23, 04:08:25<span class="o">]</span>, Group: <span class="s2">&#34;com.apple.dasd.defaultNetwork&#34;</span>, Networking: <span class="nv">Upload</span><span class="o">=</span>0, <span class="nv">UploadSize</span><span class="o">=</span>0, <span class="nv">DownloadSize</span><span class="o">=</span>5000, WiFi-Only<span class="o">=</span>0, Require Device Inactivity, Plugin Required, Dark-Wake Eligible, <span class="nv">Interval</span><span class="o">=</span>1440, Budgeted, Delayed Start, User Specified: <span class="o">{</span> <span class="o">}</span>&gt;
</span></span><span class="line"><span class="cl">Activity com.apple.DifferentialPrivacy.serverBlacklistUpdate:6CB527 start beyond the <span class="m">21</span> hour interval
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了能不等待这么久，我们需要一种能快速启动这些XPC活动的手段，来追踪它们调用的方法。</p>
<h4 id="随时启动xpc活动">随时启动XPC活动<a hidden class="anchor" aria-hidden="true" href="#随时启动xpc活动">#</a></h4>
<p>过去的一段时间，我的项目需要对一个越狱的iOS设备的系统级进程（Daemon）进行动态分析，它的<code>.plist</code>中定义了许多XPC活动。</p>
<p>但由于这些XPC活动是周期运行，最短间隔12小时，最长则是24小时，有时它们还需要在系统条件满足时执行。我不想等这么久来获得我想要追踪的结果。</p>
<p>我非常幸运地找到了这篇文章（<a href="https://bryce.co/running-xpc-activities-on-demand/">Running XPC Activities On Demand</a>）</p>
<h2 id="哪些情况会触发数据收集收集了什么">哪些情况会触发数据收集？收集了什么？<a hidden class="anchor" aria-hidden="true" href="#哪些情况会触发数据收集收集了什么">#</a></h2>
<p>当用户使用某些特定应用程序时，他们的操作会产生大量数据。这些数据会从用户通过特定服务（如键盘守护进程 <code>kbd</code> ）或直接从服务（如 <code>suggestd</code> 守护进程）流向应用程序。当数据流到达某些服务时，服务会记录并通过进程间通信（Cross-Process Communication - XPC）机制发送给 <code>dprivacyd</code>。<code>dprivacyd</code> 收到服务的明文数据后，会决定是否记录这些数据。如果用户在 <code>设置→隐私→分析和改进→分享iPhone分析</code> 中选择了 &ldquo;记录&rdquo;，<code>dprivacyd</code> 就会决定记录，然后通过算法将数据私有化并存储到数据库中。</p>
<h3 id="使用差分隐私技术的服务">使用「差分隐私技术」的服务<a hidden class="anchor" aria-hidden="true" href="#使用差分隐私技术的服务">#</a></h3>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://arxiv.org/abs/1709.02753">Privacy Loss in Apple&rsquo;s Implementation of Differential Privacy on MacOS 10.12</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/zh/posts/xpcactivity/">
    <span class="title">下一页 »</span>
    <br>
    <span>Using Frida to trigger XPC Activities</span>
  </a>
</nav>

  </footer><div id="waline"></div>
<script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({
      el: '#waline',
      serverURL: 'https://waline-comment-ej99wzs72-roesinns-projects.vercel.app/',
      lang: 'en',
    });
</script>
</article>
    </main>
    
<footer class="footer">
        <span>© 2016-2024 ro2en - tech blog.</span>
        
        All rights reserved.
        

    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            
            
                delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: "\begin{equation}", right: "\end{equation}", display: true},
                {left: "\begin{align}", right: "\end{align}", display: true},
            ],
            
            throwOnError : false
        });
    });
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
