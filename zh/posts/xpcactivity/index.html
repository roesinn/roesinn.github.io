<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用Frida运行XPC活动 | ro2en - tech blog</title>
<meta name=keywords content="frida"><meta name=description content="前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多XPC活动（XPC Activities）组成。我们可"><meta name=author content="ro2en"><link rel=canonical href=https://ro2en.me/zh/posts/xpcactivity/><link crossorigin=anonymous href=/assets/css/stylesheet.1fc7633352002c726fac2f2267f2f70aa2fd3784e85196c36b507bda4d3ee0ad.css integrity="sha256-H8djM1IALHJvrC8iZ/L3CqL9N4ToUZbDa1B72k0+4K0=" rel="preload stylesheet" as=style><link rel=icon href=https://ro2en.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ro2en.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ro2en.me/favicon-32x32.png><link rel=apple-touch-icon href=https://ro2en.me/apple-touch-icon.png><link rel=mask-icon href=https://ro2en.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ro2en.me/posts/xpcactivity/><link rel=alternate hreflang=zh href=https://ro2en.me/zh/posts/xpcactivity/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css integrity=sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js integrity=sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous onload=renderMathInElement(document.body)></script><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><meta property="og:title" content="使用Frida运行XPC活动"><meta property="og:description" content="前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多XPC活动（XPC Activities）组成。我们可"><meta property="og:type" content="article"><meta property="og:url" content="https://ro2en.me/zh/posts/xpcactivity/"><meta property="og:image" content="https://ro2en.me/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-10T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ro2en.me/images/papermod-cover.png"><meta name=twitter:title content="使用Frida运行XPC活动"><meta name=twitter:description content="前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多XPC活动（XPC Activities）组成。我们可"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ro2en.me/zh/posts/"},{"@type":"ListItem","position":2,"name":"使用Frida运行XPC活动","item":"https://ro2en.me/zh/posts/xpcactivity/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用Frida运行XPC活动","name":"使用Frida运行XPC活动","description":"前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多XPC活动（XPC Activities）组成。我们可","keywords":["frida"],"articleBody":"前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多XPC活动（XPC Activities）组成。我们可以在该进程的.plist配置文件（位于 /System/Library/LaunchDaemons）内的LaunchEvents字段下找到这些 XPC 活动：\n# audioanalyticsd 为示例Daemon $ plutil -p \"/System/Library/LaunchDaemons/com.apple.audioanalyticsd.plist\" # ... \"Label\" =\u003e \"com.apple.audioanalyticsd\" \"LaunchEvents\" =\u003e { # 该Daemon的XPC活动 \"com.apple.xpc.activity\" =\u003e { \"com.apple.audioanalyticsd.assets.refresh\" =\u003e { \"AllowBattery\" =\u003e 0 \"GracePeriod\" =\u003e 1800 \"Interval\" =\u003e 43200 # 运行间隔 12h = 43200s/3600s \"Priority\" =\u003e \"Maintenance\" \"Repeating\" =\u003e 1 } } } \"ProgramArguments\" =\u003e [ 0 =\u003e \"/usr/libexec/audioanalyticsd\" ] # ... 但这些 XPC 活动常常有定义好的运行周期，示例中为12小时，有些更长达24小时；有的 XPC 活动还需要等待系统条件满足才能运行。这导致对它们动态分析实在很困难。所以我想寻找能手动运行这些 XPC 活动的方法。\nBryce 的这篇文章给了我很多启发。他通过观察 Console 应用中的日志，发现有个叫做dasd（DuetActivitySchedulerDaemon）的进程负责决定什么时候运行什么 XPC 活动。他尝试使用调试工具 lldb 调试dasd进程：先获得_DASDaemon类实例，再调用它的方法‑[_DASDaemon forceRunActivities:]。这成功触发了对应的XPC活动！\n(lldb) e (void)[[_DASDaemon sharedInstance] forceRunActivities:@[@\"com.apple.CacheDelete.daily\"]] 接下来他构建了一个命令行工具，这个工具将改写后的forceRunActivities:completion:方法放在新协议中，再使用 Theos hook了XPC通信接口类NSXPCInterface，并且在_DASDaemonClient（与_DASDaemon选择器相同）加载后，经过XPC通信用新协议新方法替换掉dasd中的原协议的原方法，以调用指定XPC活动并提供反馈。\n但这个方法还是过于复杂了。我们可以用 Frida 加载脚本来hook dasd进程。\n测试：Frida 实时调用XPC活动 我们的思路很清晰：先访问_DASDaemon类的实例，再通过该实例调用‑[_DASDaemon forceRunActivities:]方法。\n首先使用 Frida 来动态调试 dasd。\nfrida -U dasd 尝试获取_DASDaemon类的实例，并将实例作为一个 Objective-C 对象。\n// 获取_DASDaemon类的实例 -\u003e sharedInstance = ObjC.classes._DASDaemon.sharedInstance(); // 将实例转化为ObjC对象 -\u003e sharedInstance = new ObjC.Object(sharedInstance); 获得实例后，尝试调用forceRunActivities:方法。根据Bryce在lldb中的测试，我们了解到该方法的参数是一个数组，数组中是表示「XPC活动」名称的字符串。因此，我们使用[NSString stringWithString:]方法将想启动的「XPC活动」的名称存入一个 NSString 类型的字符串，再将字符串放入一个NSArray类型的数组，作为参数传入‑[_DASDaemon forceRunActivities:]方法。注意，需要提前声明NSString和NSArray为 Objective-C 的类，否则会报错。\n// 声明ObjC的类 -\u003e const { NSString, NSArray } = ObjC.classes; // 初始化ObjC字符串并赋值 -\u003e const activity_string = NSString['stringWithString:']('com.apple.audioanalyticsd.assets.refresh'); // 初始化ObjC数组并赋值 -\u003e const activity_array = NSArray.alloc().initWithObject_(activity_string); // 调用实例的方法并传参 -\u003e sharedInstance.forceRunActivities_(activity_array); 在 Console 应用中，我们观察到特定的 XPC Activities 启动成功！接下来，我们把它写成一个JS脚本，以便直接加载。\n完成：Frida 脚本调用XPC活动 根据上一步的方法，我们构建了以下的JS脚本，并将调用‑[_DASDaemon forceRunActivities:]方法的行为封装进一个函数run_activity：\n// dasd_schedule_activity.js console.log(\"reloaded script\"); var sharedInstance = ObjC.classes._DASDaemon.sharedInstance(); sharedInstance = new ObjC.Object(sharedInstance); console.log(\"Got DASDaemon instance: \" + sharedInstance); function run_activity(activity_name) { const {NSString, NSArray} = ObjC.classes; const activity_string = NSString['stringWithString:'](activity_name); const activity_array = NSArray.alloc().initWithObject_(activity_string); sharedInstance.forceRunActivities_(activity_array); console.log(\"ran activity\"); } console.log(\"run_activity('xpc_activity_name')\"); 使用 Frida 加载 JS 脚本，再运行run_activity函数来调用任意XPC活动：\nfrida -U dasd --load dasd_schedule_activity.js -\u003e run_activity('your_xpc_activity_name') 完成！现在你可以按需启动 XPC 活动了。\n（特别鸣谢 Jiska）\n","wordCount":"1461","inLanguage":"zh","image":"https://ro2en.me/images/papermod-cover.png","datePublished":"2023-08-10T00:00:00Z","dateModified":"2023-08-10T00:00:00Z","author":[{"@type":"Person","name":"ro2en"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ro2en.me/zh/posts/xpcactivity/"},"publisher":{"@type":"Organization","name":"ro2en - tech blog","logo":{"@type":"ImageObject","url":"https://ro2en.me/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ro2en.me/zh/ class=logo-text accesskey=h title="ro2en - tech blog (Alt + H)">ro2en - tech blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"><path id="adjust-solid" d="M8 17a9 9 0 109-9A9 9 0 008 17zm9 6.677V10.323a6.677 6.677.0 110 13.355z" transform="translate(12.728 -11.314) rotate(45)" fill="currentcolor"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"><path id="adjust-solid" d="M8 17a9 9 0 109-9A9 9 0 008 17zm9 6.677V10.323a6.677 6.677.0 110 13.355z" transform="translate(12.728 -11.314) rotate(45)" fill="currentcolor"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ro2en.me/ title=en aria-label=en>en</a></li></ul></div></div><ul id=menu><li><a href=https://ro2en.me/zh/archives/ title=歸檔><span>歸檔</span></a></li><li><a href=https://ro2en.me/zh/zhtags title=標籤><span>標籤</span></a></li><li><a href=https://ro2en.me/zh/zhcategories title=類目><span>類目</span></a></li><li><a href=https://ro2en.me/zh/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ro2en.me/zh/>主页</a>&nbsp;»&nbsp;<a href=https://ro2en.me/zh/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">使用Frida运行XPC活动</h1><div class=post-meta><span title='2023-08-10 00:00:00 +0000 UTC'>八月 10, 2023</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;ro2en&nbsp;|&nbsp;语言:<ul class=i18n_list><li><a href=https://ro2en.me/posts/xpcactivity/>en</a></li></ul></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e6%b5%8b%e8%af%95frida-%e5%ae%9e%e6%97%b6%e8%b0%83%e7%94%a8xpc%e6%b4%bb%e5%8a%a8 aria-label="测试：Frida 实时调用XPC活动">测试：Frida 实时调用XPC活动</a></li><li><a href=#%e5%ae%8c%e6%88%90frida-%e8%84%9a%e6%9c%ac%e8%b0%83%e7%94%a8xpc%e6%b4%bb%e5%8a%a8 aria-label="完成：Frida 脚本调用XPC活动">完成：Frida 脚本调用XPC活动</a></li></ul></div></details></div><div class=post-content><p>前不久，我的项目需要对一个 iOS 设备的系统级进程（Daemon）进行动态分析，这个进程由许多<strong>XPC活动</strong>（XPC Activities）组成。我们可以在该进程的<code>.plist</code>配置文件（位于 <code>/System/Library/LaunchDaemons</code>）内的<code>LaunchEvents</code>字段下找到这些 XPC 活动：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># audioanalyticsd 为示例Daemon</span>
</span></span><span class=line><span class=cl>$ plutil -p <span class=s2>&#34;/System/Library/LaunchDaemons/com.apple.audioanalyticsd.plist&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Label&#34;</span> <span class=o>=</span>&gt; <span class=s2>&#34;com.apple.audioanalyticsd&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;LaunchEvents&#34;</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 该Daemon的XPC活动</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;com.apple.xpc.activity&#34;</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;com.apple.audioanalyticsd.assets.refresh&#34;</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;AllowBattery&#34;</span> <span class=o>=</span>&gt; <span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;GracePeriod&#34;</span> <span class=o>=</span>&gt; <span class=m>1800</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Interval&#34;</span> <span class=o>=</span>&gt; <span class=m>43200</span>  <span class=c1># 运行间隔 12h = 43200s/3600s</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Priority&#34;</span> <span class=o>=</span>&gt; <span class=s2>&#34;Maintenance&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Repeating&#34;</span> <span class=o>=</span>&gt; <span class=m>1</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ProgramArguments&#34;</span> <span class=o>=</span>&gt; <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=nv>0</span> <span class=o>=</span>&gt; <span class=s2>&#34;/usr/libexec/audioanalyticsd&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></div><p>但这些 XPC 活动常常有定义好的运行周期，示例中为12小时，有些更长达24小时；有的 XPC 活动还需要等待系统条件满足才能运行。这导致对它们动态分析实在很困难。所以我想寻找能手动运行这些 XPC 活动的方法。</p><p>Bryce 的<a href=https://bryce.co/running-xpc-activities-on-demand/>这篇文章</a>给了我很多启发。他通过观察 Console 应用中的日志，发现有个叫做<code>dasd</code>（DuetActivitySchedulerDaemon）的进程负责决定什么时候运行什么 XPC 活动。他尝试使用调试工具 lldb 调试<code>dasd</code>进程：先获得<code>_DASDaemon</code>类实例，再调用它的方法<code>‑[_DASDaemon forceRunActivities:]</code>。这成功触发了对应的XPC活动！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> e <span class=o>(</span>void<span class=o>)[[</span>_DASDaemon sharedInstance<span class=o>]</span> 
</span></span><span class=line><span class=cl>	forceRunActivities:@<span class=o>[</span>@<span class=s2>&#34;com.apple.CacheDelete.daily&#34;</span><span class=o>]]</span>
</span></span></code></pre></div><p>接下来他构建了一个命令行工具，这个工具将改写后的<code>forceRunActivities:completion:</code>方法放在新协议中，再使用 <a href=https://github.com/theos/theos>Theos</a> hook了XPC通信接口类<code>NSXPCInterface</code>，并且在<code>_DASDaemonClient</code>（与<code>_DASDaemon</code>选择器相同）加载后，经过XPC通信用新协议新方法替换掉<code>dasd</code>中的原协议的原方法，以调用指定XPC活动并提供反馈。</p><p>但这个方法还是过于复杂了。我们可以用 Frida 加载脚本来hook <code>dasd</code>进程。</p><h3 id=测试frida-实时调用xpc活动>测试：Frida 实时调用XPC活动<a hidden class=anchor aria-hidden=true href=#测试frida-实时调用xpc活动>#</a></h3><blockquote><p>我们的思路很清晰：先访问<code>_DASDaemon</code>类的实例，再通过该实例调用<code>‑[_DASDaemon forceRunActivities:]</code>方法。</p></blockquote><p>首先使用 Frida 来动态调试 <code>dasd</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>frida -U dasd
</span></span></code></pre></div><p>尝试获取<code>_DASDaemon</code>类的实例，并将实例作为一个 Objective-C 对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 获取_DASDaemon类的实例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=nx>sharedInstance</span> <span class=o>=</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nx>classes</span><span class=p>.</span><span class=nx>_DASDaemon</span><span class=p>.</span><span class=nx>sharedInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 将实例转化为ObjC对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=nx>sharedInstance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nb>Object</span><span class=p>(</span><span class=nx>sharedInstance</span><span class=p>);</span>
</span></span></code></pre></div><p>获得实例后，尝试调用<code>forceRunActivities:</code>方法。根据Bryce在lldb中的测试，我们了解到该方法的参数是一个<strong>数组</strong>，数组中是表示「XPC活动」名称的<strong>字符串</strong>。因此，我们使用<code>[NSString stringWithString:]</code>方法将想启动的「XPC活动」的名称存入一个 <code>NSString</code> 类型的字符串，再将字符串放入一个<code>NSArray</code>类型的数组，作为参数传入<code>‑[_DASDaemon forceRunActivities:]</code>方法。注意，需要提前声明<code>NSString</code>和<code>NSArray</code>为 Objective-C 的类，否则会报错。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 声明ObjC的类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>NSString</span><span class=p>,</span> <span class=nx>NSArray</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nx>classes</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 初始化ObjC字符串并赋值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=kr>const</span> <span class=nx>activity_string</span> <span class=o>=</span> <span class=nx>NSString</span><span class=p>[</span><span class=s1>&#39;stringWithString:&#39;</span><span class=p>](</span><span class=s1>&#39;com.apple.audioanalyticsd.assets.refresh&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 初始化ObjC数组并赋值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=kr>const</span> <span class=nx>activity_array</span> <span class=o>=</span> <span class=nx>NSArray</span><span class=p>.</span><span class=nx>alloc</span><span class=p>().</span><span class=nx>initWithObject_</span><span class=p>(</span><span class=nx>activity_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 调用实例的方法并传参
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-&gt;</span> <span class=nx>sharedInstance</span><span class=p>.</span><span class=nx>forceRunActivities_</span><span class=p>(</span><span class=nx>activity_array</span><span class=p>);</span>
</span></span></code></pre></div><p>在 Console 应用中，我们观察到特定的 XPC Activities 启动成功！接下来，我们把它写成一个JS脚本，以便直接加载。</p><h3 id=完成frida-脚本调用xpc活动>完成：Frida 脚本调用XPC活动<a hidden class=anchor aria-hidden=true href=#完成frida-脚本调用xpc活动>#</a></h3><p>根据上一步的方法，我们构建了以下的JS脚本，并将调用<code>‑[_DASDaemon forceRunActivities:]</code>方法的行为封装进一个函数<code>run_activity</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// dasd_schedule_activity.js
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;reloaded script&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sharedInstance</span> <span class=o>=</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nx>classes</span><span class=p>.</span><span class=nx>_DASDaemon</span><span class=p>.</span><span class=nx>sharedInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>sharedInstance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nb>Object</span><span class=p>(</span><span class=nx>sharedInstance</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Got DASDaemon instance: &#34;</span> <span class=o>+</span> <span class=nx>sharedInstance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>run_activity</span><span class=p>(</span><span class=nx>activity_name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span><span class=nx>NSString</span><span class=p>,</span> <span class=nx>NSArray</span><span class=p>}</span> <span class=o>=</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nx>classes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>activity_string</span> <span class=o>=</span> <span class=nx>NSString</span><span class=p>[</span><span class=s1>&#39;stringWithString:&#39;</span><span class=p>](</span><span class=nx>activity_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>activity_array</span> <span class=o>=</span> <span class=nx>NSArray</span><span class=p>.</span><span class=nx>alloc</span><span class=p>().</span><span class=nx>initWithObject_</span><span class=p>(</span><span class=nx>activity_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>sharedInstance</span><span class=p>.</span><span class=nx>forceRunActivities_</span><span class=p>(</span><span class=nx>activity_array</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;ran activity&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;run_activity(&#39;xpc_activity_name&#39;)&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>使用 Frida 加载 JS 脚本，再运行<code>run_activity</code>函数来调用任意XPC活动：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>frida -U dasd --load dasd_schedule_activity.js
</span></span><span class=line><span class=cl>-&gt; run_activity<span class=o>(</span><span class=s1>&#39;your_xpc_activity_name&#39;</span><span class=o>)</span>
</span></span></code></pre></div><p>完成！现在你可以按需启动 XPC 活动了。</p><p>（特别鸣谢 <a href=https://twitter.com/naehrdine>Jiska</a>）</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://ro2en.me/zh/posts/securitypara/><span class=title>下一页 »</span><br><span>密码协议中的安全参数</span></a></nav></footer><div id=waline></div><script type=module>
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({
      el: '#waline',
      serverURL: 'https://waline-comment-ej99wzs72-roesinns-projects.vercel.app/',
      lang: 'en',
    });
</script></article></main><footer class=footer><span>© 2016-2024 ro2en - tech blog.</span>
All rights reserved.</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"egin{equation}",right:"end{equation}",display:!0},{left:"egin{align}",right:"end{align}",display:!0}],throwOnError:!1})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>